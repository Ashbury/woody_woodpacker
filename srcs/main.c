#include "woody_woodpacker.h"

char	unpacking_section[UNPACKING_SECTION_SIZE] = "\x55\x48\x89\xe5\x50\x51\x52\x53\x56\x57\x41\x50\x41\x51\x41\x52\x41\x53\x41\x54\x41\x55\x41\x56\x41\x57\x48\xbf\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\x48\xbe\xdd\xdd\xdd\xdd\xdd\xdd\xdd\xdd\x4d\x89\xe0\x49\x29\xf0\x4c\x01\xc7\x57\x48\xbf\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xcc\x4c\x01\xc7\x57\x48\x81\xec\x10\x02\x00\x00\x48\xb8\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xbb\x48\x89\x04\x24\x48\xb8\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xbb\x48\x89\x44\x24\x08\x48\xb8\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xbb\x48\x89\x44\x24\x10\x48\xb8\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xbb\x48\x89\x44\x24\x18\x48\x8d\x3c\x24\x48\x8d\xb4\x24\xf0\x00\x00\x00\xe8\x07\x02\x00\x00\x48\x8d\x3c\x24\x48\x8b\xb4\x24\x10\x02\x00\x00\x48\x8d\x94\x24\xf0\x00\x00\x00\xe8\xee\x05\x00\x00\x4c\x8b\x84\x24\x10\x02\x00\x00\x49\xbc\xee\xee\xee\xee\xee\xee\xee\xee\x4d\x89\xe6\x4d\x89\xc5\xeb\x1c\x49\x83\xee\x10\x49\x83\xc5\x10\x48\x8d\x3c\x24\x4c\x89\xee\x48\x8d\x94\x24\xf0\x00\x00\x00\xe8\xb8\x05\x00\x00\x49\x83\xfe\x20\x7d\xde\x48\xb8\x2e\x2e\x2e\x2e\x77\x6f\x6f\x64\x48\x89\x84\x24\xf0\x01\x00\x00\x48\xb8\x79\x2e\x2e\x2e\x2e\x0a\x00\x00\x48\x89\x84\x24\xf8\x01\x00\x00\xb8\x01\x00\x00\x00\xbf\x01\x00\x00\x00\x48\x8d\xb4\x24\xf0\x01\x00\x00\xba\x0e\x00\x00\x00\x0f\x05\x48\x81\xc4\x18\x02\x00\x00\x41\x5c\x41\x5f\x41\x5e\x41\x5d\x48\x83\xc4\x08\x41\x5b\x41\x5a\x41\x59\x41\x58\x5f\x5e\x5b\x5a\x59\x58\x5d\x41\xff\xe4\xb8\x3c\x00\x00\x00\x48\x31\xff\x0f\x05\x66\x0f\x1f\x44\x00\x00\x55\x48\x89\xe5\x41\xb8\x00\x00\x00\x00\x41\xb9\x00\x00\x00\x00\x41\xb0\x01\x41\xb1\x01\x41\xba\x00\x00\x00\x00\x41\xbb\x00\x00\x00\x00\x44\x88\xc0\x44\x88\xc1\xd0\xe1\x30\xc8\xb1\x00\x41\x80\xe0\x80\x74\x02\xb1\x1b\x30\xc8\x41\x88\xc0\x44\x88\xc8\x44\x88\xc9\xd0\xe1\x30\xc8\x88\xc1\xc0\xe1\x02\x30\xc8\x88\xc1\xc0\xe1\x04\x30\xc8\x88\xc1\x41\xb1\x00\x80\xe1\x80\x74\x03\x41\xb1\x09\x44\x30\xc8\x41\x88\xc1\x44\x88\xce\x45\x88\xca\x45\x88\xcb\x41\xd0\xe2\x41\xc0\xeb\x07\x45\x08\xda\x44\x30\xd6\x45\x88\xca\x45\x88\xcb\x41\xc0\xe2\x02\x41\xc0\xeb\x06\x45\x08\xda\x44\x30\xd6\x45\x88\xca\x45\x88\xcb\x41\xc0\xe2\x03\x41\xc0\xeb\x05\x45\x08\xda\x44\x30\xd6\x45\x88\xca\x45\x88\xcb\x41\xc0\xe2\x04\x41\xc0\xeb\x04\x45\x08\xda\x44\x30\xd6\x40\x80\xf6\x63\xb8\x00\x00\x00\x00\x44\x88\xc0\x40\x88\x34\x07\x41\x80\xf8\x01\x0f\x85\x50\xff\xff\xff\xc6\x07\x63\xc9\xc3\x66\x0f\x1f\x84\x00\x00\x00\x00\x00\x55\x48\x89\xe5\x48\x83\xec\x10\xb9\x00\x00\x00\x00\x4c\x8d\x04\x24\xb8\x00\x00\x00\x00\x8a\x04\x0e\x8a\x04\x07\x41\x88\x04\x08\x48\xff\xc1\x48\x83\xf9\x04\x75\xe4\x41\x8b\x00\x48\x83\xc4\x10\xc9\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x0f\x1f\x40\x00\x55\x48\x89\xe5\xb8\x00\x00\x00\x00\xba\x00\x00\x00\x00\x89\xf8\x89\xfa\xc1\xe8\x08\xc1\xe2\x18\x09\xd0\xc9\xc3\x0f\x1f\x40\x00\x55\x48\x89\xe5\x41\x54\x41\x55\x41\x56\x48\x83\xec\x28\x48\x89\x34\x24\x49\x89\xfc\x48\x8b\x3c\x24\xe8\xa2\xfe\xff\xff\x41\xbd\x08\x00\x00\x00\x41\xbe\x1c\x00\x00\x00\xc6\x44\x24\x10\x01\xba\x00\x00\x00\x00\xb9\x04\x00\x00\x00\x4c\x89\xe8\xf7\xf1\x85\xd2\x75\x52\x48\x8b\x3c\x24\x4d\x89\xe2\x4d\x01\xf2\x4c\x89\xd6\xe8\x4c\xff\xff\xff\x41\x89\xc1\xba\x00\x00\x00\x00\xb9\x08\x00\x00\x00\x4c\x89\xe8\xf7\xf1\x85\xd2\x75\x2e\x44\x89\xcf\xe8\x6e\xff\xff\xff\xbf\x00\x00\x00\x00\x40\x8a\x7c\x24\x10\x48\x89\xc6\x41\x88\xf8\x41\xfe\xc0\x44\x88\x44\x24\x10\xe8\x73\x00\x00\x00\x41\x89\xc1\xeb\x04\x47\x8b\x0c\x34\x49\x83\xc6\x04\x47\x8b\x54\x34\xe0\x45\x31\xd1\x47\x89\x0c\x34\x49\xff\xc5\x49\x83\xfd\x3c\x0f\x85\x7a\xff\xff\xff\x48\x83\xc4\x20\x41\x5e\x41\x5d\x41\x5c\xc9\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x0f\x1f\x44\x00\x00\x55\x48\x89\xe5\xb8\x01\x00\x00\x00\x48\x83\xff\x01\x74\x21\x48\xff\xcf\xe8\xe9\xff\xff\xff\xb9\x02\x00\x00\x00\x48\x3d\x80\x00\x00\x00\x7c\x09\x66\xf7\xe1\x66\x35\x1b\x01\xeb\x03\x66\xf7\xe1\xc9\xc3\x55\x48\x89\xe5\xe8\xc5\xff\xff\xff\x31\xf0\xc9\xc3\x90\x55\x48\x89\xe5\x4c\x8b\x17\x4c\x8b\x1e\x4d\x31\xda\x4c\x89\x17\x4c\x8b\x57\x08\x4c\x8b\x5e\x08\x4d\x31\xda\x4c\x89\x57\x08\xc9\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x0f\x1f\x44\x00\x00\x55\x48\x89\xe5\x48\x89\xf8\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\x31\xf8\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\x31\xf8\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\xc9\xc3\x55\x48\x89\xe5\x48\x89\xf8\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\x31\xf8\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\x31\xf8\xc9\xc3\x55\x48\x89\xe5\x48\x89\xf8\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\x31\xf8\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\x31\xf8\xc9\xc3\x55\x48\x89\xe5\x48\x89\xf8\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\xd1\xe0\x84\xe4\x74\x06\x48\x35\x1b\x01\x00\x00\x48\x31\xf8\xc9\xc3\x55\x48\x89\xe5\x41\x54\x41\x55\x41\x56\x41\x57\xb9\x00\x00\x00\x00\x41\xbc\x00\x00\x00\x00\x41\xbd\x00\x00\x00\x00\x41\xbe\x00\x00\x00\x00\x41\xbf\x00\x00\x00\x00\x48\x89\xfa\xe9\xfa\x00\x00\x00\x44\x8a\x22\x44\x8a\x6a\x01\x44\x8a\x72\x02\x44\x8a\x7a\x03\x4c\x89\xe7\xe8\xe3\xfe\xff\xff\x49\x89\xc0\x4c\x89\xef\xe8\x44\xff\xff\xff\x49\x89\xc1\x4c\x89\xf7\xe8\x03\xff\xff\xff\x49\x89\xc2\x4c\x89\xff\xe8\x64\xff\xff\xff\x49\x89\xc3\x4d\x31\xc8\x4d\x31\xda\x4d\x31\xd0\x44\x88\x02\x4c\x89\xe7\xe8\x4d\xff\xff\xff\x49\x89\xc0\x4c\x89\xef\xe8\xa0\xfe\xff\xff\x49\x89\xc1\x4c\x89\xf7\xe8\x01\xff\xff\xff\x49\x89\xc2\x4c\x89\xff\xe8\xc0\xfe\xff\xff\x49\x89\xc3\x4d\x31\xc8\x4d\x31\xda\x4d\x31\xd0\x44\x88\x42\x01\x4c\x89\xe7\xe8\xa8\xfe\xff\xff\x49\x89\xc0\x4c\x89\xef\xe8\x09\xff\xff\xff\x49\x89\xc1\x4c\x89\xf7\xe8\x5c\xfe\xff\xff\x49\x89\xc2\x4c\x89\xff\xe8\xbd\xfe\xff\xff\x49\x89\xc3\x4d\x31\xc8\x4d\x31\xda\x4d\x31\xd0\x44\x88\x42\x02\x4c\x89\xe7\xe8\xa5\xfe\xff\xff\x49\x89\xc0\x4c\x89\xef\xe8\x64\xfe\xff\xff\x49\x89\xc1\x4c\x89\xf7\xe8\xc5\xfe\xff\xff\x49\x89\xc2\x4c\x89\xff\xe8\x18\xfe\xff\xff\x49\x89\xc3\x4d\x31\xc8\x4d\x31\xda\x4d\x31\xd0\x44\x88\x42\x03\x48\x83\xc1\x04\x48\x83\xc2\x04\x48\x83\xf9\x10\x0f\x8c\xfc\xfe\xff\xff\x41\x5f\x41\x5e\x41\x5d\x41\x5c\xc9\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x66\x90\x55\x48\x89\xe5\xba\x00\x00\x00\x00\x49\x89\xf8\xb8\x00\x00\x00\x00\x41\x8a\x04\x10\xb9\x00\x01\x00\x00\x48\x89\xf7\xf2\xae\x48\xf7\xd1\x41\x88\x0c\x10\x48\xff\xc2\x48\x83\xfa\x10\x75\xdd\xc9\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x0f\x1f\x44\x00\x00\x55\x48\x89\xe5\x48\x83\xec\x10\xb9\x00\x00\x00\x00\x41\xba\x04\x00\x00\x00\x41\xbb\x10\x00\x00\x00\x41\xb8\x00\x00\x00\x00\x4c\x89\xc0\x49\xf7\xe2\x4c\x01\xc0\xba\x00\x00\x00\x00\x41\xf7\xf3\x48\x89\xc8\x4c\x01\xc0\x44\x8a\x0c\x07\x48\x89\xc8\x48\x01\xd0\x44\x88\x0c\x04\x49\xff\xc0\x49\x83\xf8\x10\x7c\xd2\xfc\xb9\x10\x00\x00\x00\x48\x8d\x34\x24\xf3\xa4\x48\x83\xc4\x10\xc9\xc3\x90\x55\x48\x89\xe5\x41\x54\x41\x55\x41\x56\x41\x57\x49\x89\xfc\x49\x89\xf5\x49\x89\xd7\x4c\x89\xef\xbe\x0e\x00\x00\x00\x48\xc1\xe6\x04\x4d\x89\xe1\x4c\x01\xce\xe8\xe4\xfc\xff\xff\x41\xbe\x0d\x00\x00\x00\xeb\x33\x4c\x89\xef\xe8\x64\xff\xff\xff\x4c\x89\xef\x4c\x89\xfe\xe8\x19\xff\xff\xff\x4c\x89\xef\x4c\x89\xf6\x48\xc1\xe6\x04\x4d\x89\xe0\x4c\x01\xc6\xe8\xb4\xfc\xff\xff\x4c\x89\xef\xe8\xb1\xfd\xff\xff\x49\xff\xce\x49\x83\xfe\x00\x7f\xc7\x4c\x89\xef\xe8\x2b\xff\xff\xff\x4c\x89\xef\x4c\x89\xfe\xe8\xe0\xfe\xff\xff\x4c\x89\xef\x4c\x89\xe6\xe8\x85\xfc\xff\xff\x41\x5f\x41\x5e\x41\x5d\x41\x5c\xc9\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x90\x55\x48\x89\xe5\x48\x8b\x56\x08\x48\x01\xf2\x48\x83\xc6\x10\xe8\x4c\x00\x00\x00\xc9\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x55\x48\x89\xe5\x4c\x8b\x07\x48\x83\xfe\x0f\x7c\x24\xeb\x0a\x48\x81\xc6\xff\x00\x00\x00\x49\xff\xc0\x41\x80\x38\xff\x74\xf0\x41\xb9\x00\x00\x00\x00\x45\x8a\x08\x4c\x01\xce\x49\xff\xc0\x4c\x89\x07\x48\x89\xf0\xc9\xc3\x66\x2e\x0f\x1f\x84\x00\x00\x00\x00\x00\x55\x48\x89\xe5\x41\x54\x41\x55\x48\x83\xec\x10\x48\x39\xd6\x0f\x8d\x9d\x00\x00\x00\x48\x89\x3c\x24\x48\x89\x74\x24\x08\x49\x89\xd5\x4d\x31\xc0\x44\x8a\x06\x4d\x89\xc4\x49\xc1\xe8\x04\x4c\x89\xc6\x49\x83\xe4\x0f\x48\x8d\x7c\x24\x08\x48\x8d\x3f\x4c\x8b\x44\x24\x08\x49\xff\xc0\x4c\x89\x44\x24\x08\xe8\x71\xff\xff\xff\xfc\x48\x8b\x3c\x24\x48\x8b\x74\x24\x08\x48\x89\xc1\xf3\xa4\x48\x89\x3c\x24\x48\x89\x74\x24\x08\x4c\x39\xee\x7d\x46\x4c\x89\xe6\x4d\x31\xe4\x4c\x8b\x44\x24\x08\x66\x45\x8b\x20\x49\x83\xc0\x02\x4c\x89\x44\x24\x08\x48\x8d\x7c\x24\x08\x48\x8d\x3f\xe8\x2f\xff\xff\xff\xfc\x48\x8b\x3c\x24\x48\x89\xfe\x4c\x29\xe6\x48\x89\xc1\x48\x83\xc1\x04\xf3\xa4\x48\x8b\x74\x24\x08\x4c\x89\xea\xe8\x4e\xff\xff\xff\x48\x83\xc4\x10\x41\x5d\x41\x5c\xc9\xc3";

static int	map_file(t_woody_data *data, char *file_name)
{
	int			fd;
	struct stat	file_stats;

	if ((fd = open(file_name, O_RDONLY)) < 0)
	{
		ft_dprintf(2, "Error while opening file.\n");
		return (0);
	}
	if (fstat(fd, &file_stats) < 0)
	{
		close(fd);
		ft_dprintf(2, "Error with fstat on file.\n");
		return (0);
	}
	data->file_len = (size_t)(file_stats.st_size);
	if ((data->file = mmap(0, data->file_len, PROT_READ | PROT_WRITE,
			MAP_PRIVATE, fd, 0)) == MAP_FAILED)
	{
		close(fd);
		ft_dprintf(2, "Error while mapping the file\n");
		return (0);
	}
	close(fd);
	return (1);
}

int			main(int ac, char **av)
{
	t_woody_data	data;

	ft_bzero(&data, sizeof(data));
	if (ac != 2)
	{
		ft_dprintf(2, "I need an argument\n");
		return (EXIT_FAILURE);
	}
	if (!map_file(&data, av[1]) || !parse_file(&data))
	{
		munmap(data.file, data.file_len);
		return (EXIT_FAILURE);
	}
	create_woody(&data);
	return (EXIT_SUCCESS);
}
